import { describe, expect, test, beforeAll } from "@jest/globals";
import supertest from "supertest";
import { app, prisma } from "..";
import nock from "nock";
import config from "../config";
import axios from "axios";
const request = supertest(app);

describe("Should run order tests", () => {
  beforeAll(async () => {
    /// Clear db first
    await prisma.orderItemImages.deleteMany({});
    await prisma.orderItem.deleteMany({});
    await prisma.order.deleteMany({});

    await prisma.order.create({
      data: {
        id: 32,
        shopifyOrderId: 4902384,
        customerName: `Anson Ervin`,
        orderDate: "January 5th 2023",
        items: {
          create: [
            {
              id: 152,
              name: "shirt",
              price: "$20.99",
              images: {
                create: [
                  {
                    id: 127,
                    url: "https://cdn.shopify.com/s/files/1/0438/5488/9116/products/image01.png?v=1599577114",
                  },
                  {
                    id: 128,
                    url: "https://cdn.shopify.com/s/files/1/0438/5488/9116/products/image01.png?v=1599577114",
                  },
                ],
              },
            },
          ],
        },
      },
    });
  });

  const expectedOrders = [
    {
      id: 32,
      customerName: "Anson Ervin",
      orderDate: "January 5th 2023",
      shopifyOrderId: 4902384,
      items: [
        {
          id: 152,
          name: "shirt",
          price: "$20.99",
          orderId: 32,
          images: [
            {
              id: 127,
              url: "https://cdn.shopify.com/s/files/1/0438/5488/9116/products/image01.png?v=1599577114",
              orderItemId: 152,
            },
            {
              id: 128,
              url: "https://cdn.shopify.com/s/files/1/0438/5488/9116/products/image01.png?v=1599577114",
              orderItemId: 152,
            },
          ],
        },
      ],
    },
  ];

  test("Should get all orders", () => {
    request
      .get(`/orders`)
      .expect(200)
      .end(function (err, res) {
        if (err) {
          return expect(err).toBe(null);
        }

        expect(JSON.stringify(res.body)).toBe(JSON.stringify(expectedOrders));
      });
  });

  test("Should get one order", () => {
    request
      .get(`/orders/32`)
      .expect(200)
      .end(function (err, res) {
        if (err) {
          return expect(err).toBe(null);
        }

        expect(JSON.stringify(res.body)).toBe(
          JSON.stringify(expectedOrders[0])
        );
      });
  });

  test("Should pull one product's info from shopify", async () => {
    nock("https://salehogs.myshopify.com:443", { encodedQueryParams: true })
      .get("/admin/api/2022-10/products/5568618791068.json")
      .reply(
        200,
        "83241400e4ff35fbbed596737f982425a028d29deb75ca35d9773c94deb2e887e017acd061b59fd57ae67fcd854889b4b2120971a17d4154d2de1226ffdf1d221a4d244eda12f2ba65d7904844429cd8d1782422c48b5319aa66fb64fb948031e2f638d4e73b5c35e0f082fe0e76002d65a52aaeea86b34a65906c72081ade6ede6d9e6c76e469b846b25df04cde637f47768890c13e0cd7ee9826071ada95b1a21fec89f4cec4f8a08d243eed83a39cb8b4b193195155994c648d48c7c50e761af7e336b8b0b4e135105b1f2ebe1a0bfcbc45321c163c2c188f7df02908a5ecf0a085589f2c9e71a193b1be85875ee2d9ceb8b0c51a08937fe206da256432d6f351e0b8e7325338e12ebcc543ba1e0de71db0e8309272d24c4b4b078c77641e661ff12249661f59ca9690a94059c3011284fe5ca2268363d9e0a9e9fbb00c3648d3d6dd95f870a547384bba0de330a3c721aa5ee96c3cbaac232006c4ea422b10622f742ab13cfe784b700e07e71a2d90fb7180416df2381fb470302ea20c9d673e8130a8d53ce48e5a9a4bb5508632106ae6d921d575b050469e3aebefde99fe8bdbc77a1e7ccac89fbe184f9e2fc6f736f6e14f19f9d3171c0392bfbffa53463e877d4821237f7a89ee84c9f686bcc715ff94916a9bae0ae2f14d89d33d8ec9f55ceedabce06471216fcd1e1d7987e409d91d173489ec683cda25111b89f1a4e2393a398485c464aed68fa45224574cb9c9c1c4a30ddeec1d6efeff3f1948da3cce0618482aa5f68b8b4f9b8bccc57f376eb0a7573af3713d5a8414605e3864ae6d1ee6bbb298698eb2c7390fa3f87bcb5b38a63447dde66d7e3e9f378b71f3d1997541bfe9c3d4e6fb708db477211dad1f69ca9ff723b6791f520a9e7ec525e295f60b9e3df6773421b63963856a8a8a8bea2031f6eaa3354d5d0cebd2e383ed9767edca98a8cc34df5bd3d44d38d8757af02284d1e1c7b74fba52d63597b5aaea4a758daca59292abb2e3ac688a8a15aae4a25d1913c17cfa63efecf060fbf5fc66fbe4eb9937dfaaa79f9ffcfb993d3f994255beddcd617eb1ff54ecb64c34cd4d2feaed0e6fd8bb8f7bfeaab9e0f33bc54e8abefd6a157dd3dfa457efffd93cbf84ed3fbefdfbd393d34df7f4ccf1d1c7dec5a57f60ce9b21fe92d54473e5421b75675a88dba1f382a78f5a6d6e9cf4205961238f97c4b1e4502d126a766366335a8dab59597ca9d60db68639e8bddb609eb42af03df20660d98497448db3a3d744f16d1ef724122ba625f8310ce79ba61545479d8cddbd8fdc0d315573c2749744ac14313d68614d07aa448e182f6375fb7939eb26e18cfd462a14a7cda93e6dfecae87fc177a63f5a8fe46ce2b1bacfd44ecedb328142b7ad640be5773e7b5f8e6149243ac41346de7cda3c652a410627f4435840c37f4248d7dd119f9a658f0b646dff725dbace081a20037d393b8243671268104c30ca142dd84e702d98960565a5660c32d02eb4088286780c4ba24ce19ab84fc8609d87c06429281394553baeb4e45ad694492274f6728bd74ada5e3f377617d7c3c15eb8be6e4c26ad1134983ed913861a18fb90b845ceb8870c9219634a198edcc5a55354b4d11fae33b3edec001a463bd475a3c56398ede1dae6ca9d4ab779af3e0432506a14cba708fabfddfe2b14b261552da42c4bd608e9721d12f41a27d2e6641dbd203b52da1e4183909bf406c5bb3557149d43b4c9060f9a6760fd097d0acbb5536b24e715340ce8af90411fa6d92cd899d405a7845f9dcbe0b0ba83756e429f3a75cac7000d93f1ab71102831aa8119db9fd91eae90c1613538729e6d9d620468601e7ebb1471b28168e58632b5e35c33a145459c4162cd3457f22573317b87a0d3b262067bb3f46180ec02e362a6089a65308201590979a196c42b05cd36cce198ddea6d020d6e9ff8489b70c2c0358aba9115e30d6f785395027fcbfe588d4f365d4153516710dcd079c05717f7895d2f0c339f95c073fa07ccca68737805c3cf0c75175a5570c10bd934bc94f4ef3e752b3e21dea11fae987b4038a34cec78a379a165437cabe9cca9a2e2655dc8529525895c995d4534b80883a1d8f5ba5215334d39e150cdf15850e88403cad47afba35ccb8ac424445917426469b69200c018cd70ab84604a28dc65d1a64dacba6e74d74bc38cc5a0b8e022431d0d2fe687e6a858533d54a51b2d8f0bfa1e6e7cfab54c731216594bc608c28bc574972c6453a12e8bac16b16a6c795a91055373215449005c2ca6294a5160ae2a2fcef0b8a41fd1c591c0344c548a00bc584c77a9aaa84ad46591d122568d47ab3c5524148a33a92c0d2ee68766a96ac91fb2b69ae3b3a4ec7ffeb2ea1912345ab5580a51b0a2220830e6c76156f08617027759b469139bc5737202576ac6685fce62516551c88a20bc42e0e76d73439c03715e6ace9510bce4ac9c9e3bae371382862ff61bf6da4279068bf3898aa0ff3bdb0fe7c340ff1d3471d2cbc5c16d47f27cd75c2ac178530a5e8b48c12592e87e622e112baec2c03c6ff0edcfdb3c2552793eb86a6a5973214ba1ea91129d306e1d3df1312d952e4a6e9e438d4b385bd20ee9085af02a8323e68e580891415c7ad0976188ee07bfc96378f90515639b1facc3d8e6bccd5959a83697a5526dde705eb51773f489ed312e3d05e39bd98f8f4e0fb86c1a59d79c97e7434ddbce0e11f47f6f41d69f579319b1cda5eb0af2c71768d3937c78fcfc690003"
      );
    const headers: any = {
      "X-Shopify-Access-Token": config.SHOPIFY_ACCESS_TOKEN,
    };
    const exampleItem = "5568618791068";
    const itemData = await axios.get(
      `https://salehogs.myshopify.com/admin/api/2022-10/products/${exampleItem}.json`,
      {
        headers: headers,
      }
    );
    expect(itemData.data).toBe(
      "83241400e4ff35fbbed596737f982425a028d29deb75ca35d9773c94deb2e887e017acd061b59fd57ae67fcd854889b4b2120971a17d4154d2de1226ffdf1d221a4d244eda12f2ba65d7904844429cd8d1782422c48b5319aa66fb64fb948031e2f638d4e73b5c35e0f082fe0e76002d65a52aaeea86b34a65906c72081ade6ede6d9e6c76e469b846b25df04cde637f47768890c13e0cd7ee9826071ada95b1a21fec89f4cec4f8a08d243eed83a39cb8b4b193195155994c648d48c7c50e761af7e336b8b0b4e135105b1f2ebe1a0bfcbc45321c163c2c188f7df02908a5ecf0a085589f2c9e71a193b1be85875ee2d9ceb8b0c51a08937fe206da256432d6f351e0b8e7325338e12ebcc543ba1e0de71db0e8309272d24c4b4b078c77641e661ff12249661f59ca9690a94059c3011284fe5ca2268363d9e0a9e9fbb00c3648d3d6dd95f870a547384bba0de330a3c721aa5ee96c3cbaac232006c4ea422b10622f742ab13cfe784b700e07e71a2d90fb7180416df2381fb470302ea20c9d673e8130a8d53ce48e5a9a4bb5508632106ae6d921d575b050469e3aebefde99fe8bdbc77a1e7ccac89fbe184f9e2fc6f736f6e14f19f9d3171c0392bfbffa53463e877d4821237f7a89ee84c9f686bcc715ff94916a9bae0ae2f14d89d33d8ec9f55ceedabce06471216fcd1e1d7987e409d91d173489ec683cda25111b89f1a4e2393a398485c464aed68fa45224574cb9c9c1c4a30ddeec1d6efeff3f1948da3cce0618482aa5f68b8b4f9b8bccc57f376eb0a7573af3713d5a8414605e3864ae6d1ee6bbb298698eb2c7390fa3f87bcb5b38a63447dde66d7e3e9f378b71f3d1997541bfe9c3d4e6fb708db477211dad1f69ca9ff723b6791f520a9e7ec525e295f60b9e3df6773421b63963856a8a8a8bea2031f6eaa3354d5d0cebd2e383ed9767edca98a8cc34df5bd3d44d38d8757af02284d1e1c7b74fba52d63597b5aaea4a758daca59292abb2e3ac688a8a15aae4a25d1913c17cfa63efecf060fbf5fc66fbe4eb9937dfaaa79f9ffcfb993d3f994255beddcd617eb1ff54ecb64c34cd4d2feaed0e6fd8bb8f7bfeaab9e0f33bc54e8abefd6a157dd3dfa457efffd93cbf84ed3fbefdfbd393d34df7f4ccf1d1c7dec5a57f60ce9b21fe92d54473e5421b75675a88dba1f382a78f5a6d6e9cf4205961238f97c4b1e4502d126a766366335a8dab59597ca9d60db68639e8bddb609eb42af03df20660d98497448db3a3d744f16d1ef724122ba625f8310ce79ba61545479d8cddbd8fdc0d315573c2749744ac14313d68614d07aa448e182f6375fb7939eb26e18cfd462a14a7cda93e6dfecae87fc177a63f5a8fe46ce2b1bacfd44ecedb328142b7ad640be5773e7b5f8e6149243ac41346de7cda3c652a410627f4435840c37f4248d7dd119f9a658f0b646dff725dbace081a20037d393b8243671268104c30ca142dd84e702d98960565a5660c32d02eb4088286780c4ba24ce19ab84fc8609d87c06429281394553baeb4e45ad694492274f6728bd74ada5e3f377617d7c3c15eb8be6e4c26ad1134983ed913861a18fb90b845ceb8870c9219634a198edcc5a55354b4d11fae33b3edec001a463bd475a3c56398ede1dae6ca9d4ab779af3e0432506a14cba708fabfddfe2b14b261552da42c4bd608e9721d12f41a27d2e6641dbd203b52da1e4183909bf406c5bb3557149d43b4c9060f9a6760fd097d0acbb5536b24e715340ce8af90411fa6d92cd899d405a7845f9dcbe0b0ba83756e429f3a75cac7000d93f1ab71102831aa8119db9fd91eae90c1613538729e6d9d620468601e7ebb1471b28168e58632b5e35c33a145459c4162cd3457f22573317b87a0d3b262067bb3f46180ec02e362a6089a65308201590979a196c42b05cd36cce198ddea6d020d6e9ff8489b70c2c0358aba9115e30d6f785395027fcbfe588d4f365d4153516710dcd079c05717f7895d2f0c339f95c073fa07ccca68737805c3cf0c75175a5570c10bd934bc94f4ef3e752b3e21dea11fae987b4038a34cec78a379a165437cabe9cca9a2e2655dc8529525895c995d4534b80883a1d8f5ba5215334d39e150cdf15850e88403cad47afba35ccb8ac424445917426469b69200c018cd70ab84604a28dc65d1a64dacba6e74d74bc38cc5a0b8e022431d0d2fe687e6a858533d54a51b2d8f0bfa1e6e7cfab54c731216594bc608c28bc574972c6453a12e8bac16b16a6c795a91055373215449005c2ca6294a5160ae2a2fcef0b8a41fd1c591c0344c548a00bc584c77a9aaa84ad46591d122568d47ab3c5524148a33a92c0d2ee68766a96ac91fb2b69ae3b3a4ec7ffeb2ea1912345ab5580a51b0a2220830e6c76156f08617027759b469139bc5737202576ac6685fce62516551c88a20bc42e0e76d73439c03715e6ace9510bce4ac9c9e3bae371382862ff61bf6da4279068bf3898aa0ff3bdb0fe7c340ff1d3471d2cbc5c16d47f27cd75c2ac178530a5e8b48c12592e87e622e112baec2c03c6ff0edcfdb3c2552793eb86a6a5973214ba1ea91129d306e1d3df1312d952e4a6e9e438d4b385bd20ee9085af02a8323e68e580891415c7ad0976188ee07bfc96378f90515639b1facc3d8e6bccd5959a83697a5526dde705eb51773f489ed312e3d05e39bd98f8f4e0fb86c1a59d79c97e7434ddbce0e11f47f6f41d69f579319b1cda5eb0af2c71768d3937c78fcfc690003"
    );
  });
});
